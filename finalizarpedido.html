<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Pedido</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f8f9fa; }
        h1 { text-align: center; color: #343a40; }
        .carrinho, .btn-limpar, .btn-finalizar { max-width: 800px; margin: 20px auto; text-align: center; }
        .carrinho { background: white; border-radius: 5px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 20px; }
        .produto-carrinho { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; padding: 10px 0; }
        .produto-info { flex: 1; display: flex; align-items: center; }
        .produto-nome { margin-left: 10px; }
        .preco-container { display: flex; flex-direction: column; align-items: flex-end; }
        .mesa-container, footer { text-align: center; }
        footer { margin-top: 30px; color: #6c757d; }
        .btn-finalizar button, .btn-limpar button { background-color: #28a745; color: white; padding: 10px 20px; border: none; cursor: pointer; }
        .btn-limpar button { background-color: #dc3545; }
        .btn-limpar button:hover, .btn-finalizar button:hover { background-color: #218838; }
        #historico-container { display: none; margin-top: 20px; }
        #historico-container table { width: 100%; border-collapse: collapse; }
        #historico-container th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #historico-container th { background-color: #343a40; color: white; }
    </style>
</head>
<body>
    <h1>Finalizar Pedido</h1>
    <div class="carrinho" id="carrinho"></div>
    <div class="mesa-container">
        <label for="mesa">Informe a mesa:</label>
        <input type="number" id="mesa" min="1" max="100" placeholder="Número da mesa" required>
    </div>
    <div><a href="catalogo.html"><b>Voltar para o catálogo</b></a></div>
    <div class="btn-limpar"><button id="limpar-pedido">Limpar Pedido</button></div>
    <div class="btn-finalizar"><button id="finalizar-pedido">Finalizar Pedido</button></div>

    <div id="historico-container">
        <h2>Histórico de Pedidos da Mesa</h2>
        <table><thead><tr><th>Produto</th><th>Quantidade</th><th>Valor Unitário</th><th>Total</th></tr></thead>
        <tbody id="historico-tbody"></tbody></table>
    </div>

    <footer><p>&copy; <b>2024 Renan Paim Couto. Todos os direitos reservados.</b></p></footer>

    <script>
        const supabaseUrl = 'https://chcysijsjivahlaekhlw.supabase.co';
        const supabaseKey = 'YOUR_SUPABASE_KEY'; 
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        let carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
        
        function renderCarrinho() {
            const carrinhoContainer = document.getElementById('carrinho');
            carrinhoContainer.innerHTML = carrinho.map(produto => `
                <div class="produto-carrinho">
                    <div class="produto-info"><img src="${produto.foto_url}" alt="Produto"><span class="produto-nome">${produto.nome} (Quantidade: ${produto.quantidade})</span></div>
                    <div class="preco-container"><span>R$ ${(produto.preco * produto.quantidade).toFixed(2)}</span>
                    <div><button onclick="alterarQuantidade(${produto.id}, 1)">+</button><button onclick="alterarQuantidade(${produto.id}, -1)">-</button></div></div>
                </div>`).join('') + 
                `<div class="produto-carrinho"><div class="produto-info"><strong>Total do Carrinho:</strong></div>
                <div class="preco-container"><span>R$ ${carrinho.reduce((acc, produto) => acc + produto.preco * produto.quantidade, 0).toFixed(2)}</span></div></div>`;
        }

        function alterarQuantidade(id, delta) {
            const produto = carrinho.find(p => p.id === id);
            produto ? produto.quantidade += delta : null;
            carrinho = carrinho.filter(p => p.quantidade > 0);
            localStorage.setItem('carrinho', JSON.stringify(carrinho));
            renderCarrinho();
        }

        document.addEventListener('DOMContentLoaded', renderCarrinho);

        document.getElementById('finalizar-pedido').addEventListener('click', async () => {
            const mesa = document.getElementById('mesa').value;
            if (!mesa) return alert('Por favor, informe o número da mesa!');
            try {
                await Promise.all(carrinho.map(async produto => {
                    const { error } = await supabaseClient.from('itens_pedido').insert([{ produto_id: produto.id, numero_mesa: mesa, quantidade: produto.quantidade, valor_unitario: produto.preco }]);
                    if (error) throw error;
                }));
                alert('Pedido finalizado com sucesso!');
                localStorage.removeItem('carrinho');
                carrinho = [];
                renderCarrinho();
                exibirHistoricoPedidos(mesa);
            } catch (error) {
                console.error('Erro ao finalizar pedido:', error);
            }
        });

        document.getElementById('limpar-pedido').addEventListener('click', () => {
            localStorage.removeItem('carrinho');
            carrinho = [];
            renderCarrinho();
        });

        async function exibirHistoricoPedidos(mesa) {
            try {
                const { data: pedidos, error } = await supabaseClient.from('itens_pedido').select('produto_id, quantidade, valor_unitario').eq('numero_mesa', mesa);
                if (error) throw error;
                document.getElementById('historico-tbody').innerHTML = pedidos.map(pedido => {
                    const total = pedido.quantidade * pedido.valor_unitario;
                    return `<tr><td>${pedido.produto_id}</td><td>${pedido.quantidade}</td><td>R$ ${pedido.valor_unitario.toFixed(2)}</td><td>R$ ${total.toFixed(2)}</td></tr>`;
                }).join('');
                document.getElementById('historico-container').style.display = 'block';
            } catch (error) {
                console.error('Erro ao exibir histórico:', error);
            }
        }
    </script>
</body>
</html>